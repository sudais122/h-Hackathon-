<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FixIt AWKUM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- MODERN DARK MODE (Midnight Blue Theme) --- */
        body.dark-mode { background-color: #0f172a; color: #cbd5e1; }
        body.dark-mode .sidebar { background-color: #1e293b; border-right: 1px solid #334155; }
        body.dark-mode .sidebar-menu a { color: #94a3b8; }
        body.dark-mode .sidebar-menu a.active { background: #334155; color: #f8fafc; border-left: 4px solid #BD2426; border-radius: 0; }
        body.dark-mode .main-content { background-color: #0f172a; }
        body.dark-mode header, body.dark-mode .card, body.dark-mode .card-single { background-color: #1e293b; color: #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); border: 1px solid #334155; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode header h2, body.dark-mode .user-wrapper h4 { color: #f8fafc; }
        body.dark-mode table td { color: #cbd5e1; }
        body.dark-mode .filter-input { background-color: #334155; color: #fff; border: 1px solid #475569; }
        body.dark-mode .modal-content { background-color: #1e293b; color: #fff; border: 1px solid #334155; }
        body.dark-mode .detail-row { border-bottom: 1px solid #334155; }
        #theme-btn { cursor: pointer; font-size: 1.2rem; color: #333; margin-right: 20px; transition: 0.3s; }
        body.dark-mode #theme-btn { color: #ffffff; }

        /* --- UI STYLES --- */
        :root { --main-color: #BD2426; --color-dark: #1D2231; }
        * { padding: 0; margin: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f1f5f9; transition: background-color 0.3s; }
        .sidebar { width: 250px; position: fixed; left: 0; top: 0; height: 100%; background: var(--main-color); z-index: 100; transition: 300ms; overflow: hidden; }
        .sidebar.hide { width: 0 !important; }
        .sidebar-brand { height: 90px; padding: 2rem; color: #fff; font-size: 1.5rem; font-weight: bold; }
        .sidebar-menu li { width: 100%; margin-bottom: 1.7rem; list-style: none; }
        .sidebar-menu a { padding-left: 2rem; display: flex; align-items: center; color: #fff; text-decoration: none; transition: 0.3s; }
        .sidebar-menu a.active { background: #fff; padding: 1rem 0 1rem 2rem; color: var(--main-color); border-radius: 30px 0 0 30px; }
        .sidebar-menu a i { font-size: 1.5rem; padding-right: 1rem; }
        
        .main-content { transition: 300ms; margin-left: 250px; }
        .main-content.hide { margin-left: 0 !important; }
        
        header { background: #fff; display: flex; justify-content: space-between; padding: 1rem 1.5rem; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); position: fixed; left: 250px; width: calc(100% - 250px); top: 0; z-index: 100; transition: 300ms; }
        header.hide { left: 0 !important; width: 100% !important; }
        #menu-btn { cursor: pointer; font-size: 1.5rem; margin-right: 1rem; }
        .user-wrapper { display: flex; align-items: center; }
        .user-wrapper img { border-radius: 50%; margin-right: 1rem; }
        
        main { margin-top: 85px; padding: 2rem 1rem; min-height: calc(100vh - 90px); }
        .cards { display: grid; grid-template-columns: repeat(4, 1fr); grid-gap: 2rem; }
        .card-single { display: flex; justify-content: space-between; background: #fff; padding: 2rem; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-single div:last-child i { font-size: 2rem; color: var(--main-color); }
        
        .card { background: #fff; border-radius: 5px; width: 100%; margin-top: 2rem; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .filter-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; min-width: 180px; }

        .table-responsive { width: 100%; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; }
        td { padding: 1rem 1.5rem; font-size: .95rem; }
        
        .status-dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
        .status-dot.Transport { background: #f39c12; }
        .status-dot.Hostel { background: #3498db; }
        .status-dot.Academic { background: #8e44ad; }
        .status-dot.Cafeteria { background: #e74c3c; }

        .action-btn { padding: 6px 14px; border: 1px solid var(--main-color); color: #333; background: transparent; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .action-btn:hover { background: var(--main-color); color: #fff; }
        .btn-view { border-color: #3498db; color: #3498db; }
        .btn-view:hover { background: #3498db; color: #fff; }

        /* Security Styling for Password */
        .pass-container { display: flex; align-items: center; gap: 8px; }
        .pass-code { font-family: 'Courier New', monospace; background: #eceff1; padding: 4px 8px; border-radius: 4px; font-weight: bold; color: #455a64; font-size: 0.8rem; }
        .copy-icon { cursor: pointer; color: #94a3b8; font-size: 0.8rem; }
        .copy-icon:hover { color: var(--main-color); }
        body.dark-mode .pass-code { background: #334155; color: #cbd5e1; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: #fff; padding: 25px; border-radius: 10px; width: 450px; position: relative; }
        .modal-header { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .detail-row { margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #f9f9f9; text-align: left; }
        .detail-row label { font-weight: bold; display: block; color: var(--main-color); font-size: 0.8rem; text-transform: uppercase; }
        .close-modal { cursor: pointer; font-size: 1.2rem; }

        @media (max-width: 1024px) { .sidebar { width: 70px; } .main-content { margin-left: 70px; } header { left: 70px; width: calc(100% - 70px); } .sidebar-menu span, .sidebar-brand { display: none; } }
        @media (max-width: 768px) { .cards { grid-template-columns: 1fr; } .sidebar { left: -100%; } .main-content { margin-left: 0; } header { left: 0; width: 100%; } .sidebar.mobile-show { left: 0; width: 250px; } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-brand">FixIt Admin</div>
        <div class="sidebar-menu">
            <ul style="margin-left: 15px;">
                <li><a href="javascript:void(0)" class="active" onclick="switchView('dashboard', this)"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="javascript:void(0)" onclick="switchView('resolved', this)"><i class="fas fa-check-circle"></i> <span>Resolved</span></a></li>
                <li><a href="javascript:void(0)" onclick="switchView('students', this)"><i class="fas fa-users"></i> <span>Students</span></a></li>
                <li><a href="Welcome.html"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </div>
    </div>

    <div class="main-content">
        <header>
            <h2><label id="menu-btn"><i class="fas fa-bars"></i></label> Dashboard</h2>
            <div class="user-wrapper">
                <i class="fas fa-moon" id="theme-btn" title="Toggle Dark Mode"></i>
                <img src="https://ui-avatars.com/api/?name=Admin+User&background=BD2426&color=fff" width="40px" height="40px">
                <div><h4>Admin</h4></div>
            </div>
        </header>

        <main>
            <div class="cards" id="stats-cards">
                <div class="card-single">
                    <div><h1 id="total-count">0</h1><span>Total Issues</span></div>
                    <div><i class="fas fa-clipboard-list"></i></div>
                </div>
                <div class="card-single">
                    <div><h1 id="pending-count">0</h1><span>Pending</span></div>
                    <div><i class="fas fa-clock"></i></div>
                </div>
                <div class="card-single">
                    <div><h1 id="resolved-count">0</h1><span>Resolved</span></div>
                    <div><i class="fas fa-check"></i></div>
                </div>
                <div class="card-single">
                    <div><h1 id="user-count">0</h1><span>Total Students</span></div>
                    <div><i class="fas fa-user-graduate"></i></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 id="table-title">Recent Problems Reported</h3>
                    <div id="filter-container">
                        <select id="category-filter" class="filter-input" onchange="applyFilters()">
                            <option value="All">All Categories</option>
                            <option value="Transport">Senior Faculty</option>
                            <option value="Hostel">Junior Faculty</option>
                            <option value="Academic">Technical Staff</option>
                            <option value="Cafeteria">Lab Hardware</option>
                            <option value="IT">Exam Section</option>
                            <option value="Technical Issue">Technical Issue</option>
                            <option value="Hygiene">Hygiene</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="view-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Issue Details</h3>
                <i class="fas fa-times close-modal" onclick="closeModal('view-modal')"></i>
            </div>
            <div id="modal-details-content"></div>
        </div>
    </div>

<script>
    let allIssues = [];
    let currentView = 'all';

    // Theme Toggle
    const themeBtn = document.getElementById('theme-btn');
    if(localStorage.getItem('adminTheme') === 'dark') document.body.classList.add('dark-mode');
    themeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('adminTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    async function loadComplaints(mode = 'all') {
        currentView = mode;
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        
        tableHead.innerHTML = `<tr><td>ID</td><td>Category</td><td>Nature</td><td>Status</td><td>Action</td></tr>`;
        tableBody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Loading...</td></tr>";

        try {
            const res = await fetch('http://localhost:3001/api/complaints');
            allIssues = await res.json();
            allIssues.reverse();

            updateStats(allIssues);
            applyFilters();
        } catch (e) { tableBody.innerHTML = "<tr><td colspan='4' style='color:red;'>Connection Error</td></tr>"; }
    }
    function applyFilters() {
    // 1. Safety Check: Don't filter if we are on the Student Management view
    const tableTitle = document.getElementById('table-title').innerText;
    if (tableTitle === "Registered Students") return;

    // 2. Get the current filter value from the dropdown
    const selectedCategory = document.getElementById('category-filter').value;
    
    // 3. Filter the global allIssues array
    const filteredData = allIssues.filter(issue => {
        // Handle potential null/undefined categories from the database
        const issueCategory = issue.category || "Other";
        
        // Category Logic: Match "All" or check if the string starts with the selection
        // (e.g., "Hygiene" matches "Hygiene: Washroom")
        const matchesCategory = (selectedCategory === 'All') || 
                                (issueCategory.startsWith(selectedCategory));

        // View Logic: If the user clicked "Resolved" in sidebar, only show Resolved.
        // If they are on "Dashboard", show everything (Pending + Resolved)
        let matchesStatusView = true;
        if (currentView === 'resolved') {
            matchesStatusView = (issue.status === 'Resolved');
        } else if (currentView === 'dashboard') {
            // Optional: You could hide resolved issues from 'Recent Problems' 
            // by adding: matchesStatusView = (issue.status !== 'Resolved');
            matchesStatusView = true; 
        }

        return matchesCategory && matchesStatusView;
    });

    // 4. Update the Table
    if (filteredData.length === 0) {
        document.getElementById('table-body').innerHTML = 
            `<tr><td colspan="5" style="text-align:center; padding:2rem; opacity:0.6;">
                <i class="fas fa-search" style="font-size:2rem; display:block; margin-bottom:10px;"></i>
                No complaints found for "${selectedCategory}"
            </td></tr>`;
    } else {
        renderTable(filteredData);
    }
    
    // 5. Update the Total Count display for the filtered results
    document.getElementById('total-count').innerText = filteredData.length;
}
function renderTable(data) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = data.map(i => `
        <tr>
            <td><b style="color:var(--main-color)">#${i.complaintId}</b></td>
            
            <td>${i.category}</td>
            
            <td>${i.location}</td>
            
            <td><b style="color:#f39c12">${i.status}</b></td>
            <td>
                <button class="action-btn btn-view" 
                    onclick="window.location.href='Detail Complain.html?id=${i._id}'">
                    View & Forward
                </button>
            </td>
        </tr>
    `).join('');
}
    // Helper to mask hash
    function maskHash(hash) {
        if (!hash) return "N/A";
        return hash.substring(0, 10) + "...";
    }

    // Helper to copy text
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        alert("Full hash copied to clipboard!");
    }

    async function loadStudentData() {
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        tableHead.innerHTML = `<tr><td>Student Name</td><td>Reg No.</td><td>Email</td><td>Department</td><td>Hashed Password</td></tr>`;
        
        try {
            const res = await fetch('http://localhost:3001/api/users');
            const students = await res.json();
            tableBody.innerHTML = students.map(s => `
                <tr>
                    <td><b>${s.fullname}</b></td>
                    <td>${s.regNo}</td>
                    <td>${s.email}</td>
                    <td>${s.department || 'N/A'}</td>
                    <td>
                        <div class="pass-container">
                            <span class="pass-code" title="${s.password}">${maskHash(s.password)}</span>
                            <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${s.password}')"></i>
                        </div>
                    </td>
                </tr>
            `).join('');
        } catch (e) { tableBody.innerHTML = "<tr><td colspan='5'>Error loading data</td></tr>"; }
    }

    function switchView(view, el) {
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
        el.classList.add('active');
        
        const filter = document.getElementById('filter-container');
        const cards = document.getElementById('stats-cards');
        const title = document.getElementById('table-title');

        if(view === 'students') {
            filter.style.display = 'none';
            cards.style.display = 'none';
            title.innerText = "Registered Students";
            loadStudentData();
        } else {
            filter.style.display = 'block';
            cards.style.display = 'grid';
            title.innerText = view === 'resolved' ? "Resolved Issues" : "Recent Problems Reported";
            loadComplaints(view);
        }
    }

    function updateStats(issues) {
        document.getElementById('total-count').innerText = issues.length;
        document.getElementById('pending-count').innerText = issues.filter(i => i.status === 'Pending').length;
        document.getElementById('resolved-count').innerText = issues.filter(i => i.status === 'Resolved').length;
    }

    async function fetchUserCount() {
        const res = await fetch('http://localhost:3001/api/users');
        const users = await res.json();
        document.getElementById('user-count').innerText = users.length;
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    window.onload = () => { loadComplaints(); fetchUserCount(); };
    document.getElementById('menu-btn').addEventListener('click', () => {
        document.querySelector('.sidebar').classList.toggle('hide');
        document.querySelector('.main-content').classList.toggle('hide');
        document.querySelector('header').classList.toggle('hide');
        if(window.innerWidth < 768) document.querySelector('.sidebar').classList.toggle('mobile-show');
    });
</script>
</body>
</html>