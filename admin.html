<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | FixIt AWKUM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- MODERN THEMING --- */
        :root { --main-color: #BD2426; --color-dark: #1D2231; --bg-light: #f1f5f9; }
        
        * { padding: 0; margin: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg-light); transition: 0.3s; }

        /* --- DARK MODE OVERRIDES --- */
        body.dark-mode { background-color: #0f172a; color: #cbd5e1; }
        body.dark-mode .sidebar { background-color: #1e293b; border-right: 1px solid #334155; }
        body.dark-mode .sidebar.hide .sidebar-menu a.active {
            background: rgba(255,255,255,0.1);
            color: #f8fafc;
        }
        body.dark-mode .sidebar-menu a.active { background: #334155; color: #f8fafc; border-left: 4px solid var(--main-color); border-radius: 0; }
        body.dark-mode header, body.dark-mode .card, body.dark-mode .card-single { background-color: #1e293b; color: #e2e8f0; border: 1px solid #334155; }
        body.dark-mode .filter-input { background-color: #334155; color: #fff; border: 1px solid #475569; }

        /* --- SIDEBAR --- */
        .sidebar { width: 250px; position: fixed; left: 0; top: 0; height: 100%; background: var(--main-color); z-index: 100; transition: 300ms; }
        .sidebar-brand { height: 90px; padding: 2rem; color: #fff; font-size: 1.5rem; font-weight: bold; }
        .sidebar-menu li { width: 100%; margin-bottom: 0.2rem; list-style: none; }
        .sidebar-menu a { padding: 1rem 2rem; display: flex; align-items: center; color: #fff; text-decoration: none; transition: 0.3s; }
        .sidebar-menu a.active { background: #fff; color: var(--main-color); border-radius: 30px 0 0 30px; }
        .sidebar-menu a i { font-size: 1.3rem; padding-right: 1rem; }
        
        /* --- MAIN CONTENT --- */
        .main-content { transition: 300ms; margin-left: 250px; }
        header { background: #fff; display: flex; justify-content: space-between; padding: 1rem 1.5rem; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); position: fixed; left: 250px; width: calc(100% - 250px); top: 0; z-index: 100; transition: 300ms; }
        #menu-btn { cursor: pointer; font-size: 1.5rem; }
        .user-wrapper { display: flex; align-items: center; gap: 15px; }
        #theme-btn { cursor: pointer; font-size: 1.2rem; }

        main { margin-top: 85px; padding: 2rem; min-height: calc(100vh - 90px); }
        
        /* --- STATS CARDS --- */
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); grid-gap: 2rem; margin-bottom: 2rem; }
        .card-single { display: flex; justify-content: space-between; background: #fff; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-single i { font-size: 2.5rem; color: var(--main-color); opacity: 0.7; }

        /* --- TABLE AREA --- */
        .card { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header { padding: 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .filter-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; }

        .table-responsive { width: 100%; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; }
        thead { background: #f8fafc; }
        body.dark-mode thead { background: #334155; }
        td { padding: 1rem 1.5rem; font-size: .95rem; border-bottom: 1px solid #f0f0f0; }
        body.dark-mode td { border-bottom: 1px solid #334155; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-pending { background: #fff7ed; color: #c2410c; }
        .status-forwarded { background: #eff6ff; color: #1d4ed8; }
        .status-resolved { background: #f0fdf4; color: #15803d; }

        .action-btn { padding: 6px 12px; border: 1px solid var(--main-color); color: var(--main-color); background: transparent; border-radius: 5px; cursor: pointer; transition: 0.3s; text-decoration: none; font-size: 0.8rem; }
        .action-btn:hover { background: var(--main-color); color: #fff; }

        /* --- PASSWORDS --- */
        .pass-code { font-family: monospace; background: #f1f5f9; padding: 4px; border-radius: 4px; font-size: 0.8rem; }
        body.dark-mode .pass-code { background: #334155; }

        /* --- SIDEBAR COLLAPSE (icon-only mode) --- */
        /* Collapses to 60px showing only centered icons, no text */
        .sidebar.hide { width: 60px; }
        .sidebar.hide .sidebar-brand { opacity: 0; pointer-events: none; }
        .sidebar.hide .sidebar-menu span { display: none; }
        .sidebar.hide .sidebar-menu a {
            padding: 1rem 0;
            justify-content: center;
        }
        /* Remove the pill shape on active when collapsed — just highlight icon */
        .sidebar.hide .sidebar-menu a.active {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 0;
        }
        .sidebar.hide .sidebar-menu a i { padding-right: 0; }

        .main-content.expand { margin-left: 60px; }
        header.expand { left: 60px; width: calc(100% - 60px); }

        /* =====================================================
           COMPLAINT AGING HIGHLIGHT STYLES
           Applied to <tr> rows for unresolved complaints only
        ====================================================== */

        /* 7–10 days old: yellow warning */
        tr.age-warning td {
            background-color: #fefce8 !important;
            border-bottom: 1px solid #fde68a !important;
        }
        tr.age-warning td b { color: #92400e !important; }
        body.dark-mode tr.age-warning td {
            background-color: #422006 !important;
            border-bottom: 1px solid #78350f !important;
        }

        /* 10+ days old: red danger */
        tr.age-danger td {
            background-color: #fff1f2 !important;
            border-bottom: 1px solid #fecdd3 !important;
        }
        tr.age-danger td b { color: #9f1239 !important; }
        body.dark-mode tr.age-danger td {
            background-color: #3b0a0a !important;
            border-bottom: 1px solid #7f1d1d !important;
        }

        /* Age badge shown next to the ID */
        .age-tag {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 7px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            vertical-align: middle;
        }
        .age-tag.warning { background: #fde68a; color: #92400e; }
        .age-tag.danger  { background: #fecdd3; color: #9f1239; }

        /* Legend strip below the table header */
        .age-legend {
            display: flex;
            gap: 18px;
            align-items: center;
            font-size: 0.78rem;
            color: #64748b;
            padding: 1rem;
        }
        .age-legend span { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .legend-dot.yellow { background: #fbbf24; }
        .legend-dot.red    { background: #f87171; }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-brand">FixIt-CS Admin</div>
        <div class="sidebar-menu">
             <ul style="padding-left: 1rem;">
                <li><a href="javascript:void(0)" id="nav-dashboard" class="active" onclick="switchView('dashboard', this)"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="javascript:void(0)" id="nav-underreview" onclick="switchView('underreview', this)"><i class="fas fa-spinner"></i> <span>Under Review</span></a></li>
                <li><a href="javascript:void(0)" id="nav-resolved" onclick="switchView('resolved', this)"><i class="fas fa-check-circle"></i> <span>Resolved</span></a></li>
                <li><a href="javascript:void(0)" id="nav-students" onclick="switchView('students', this)"><i class="fas fa-users"></i> <span>Students</span></a></li>
                <li><a href="Welcome.html"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <header id="header">
            <h2><label id="menu-btn"><i class="fas fa-bars"></i></label> Dashboard</h2>
            <div class="user-wrapper">
                <i class="fas fa-moon" id="theme-btn"></i>
                <img src="https://ui-avatars.com/api/?name=Admin&background=BD2426&color=fff" width="40px" height="40px" style="border-radius: 50%;">
                <div><h4>Chairman</h4></div>
            </div>
        </header>

        <main>
            <div class="cards" id="stats-cards" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div class="card-single">
                    <div><h1 id="total-count">0</h1><span>Total Reports</span></div>
                    <div><i class="fas fa-clipboard-list"></i></div>
                </div>
                <div class="card-single">
                    <div><h1 id="pending-count">0</h1><span>New Pending</span></div>
                    <div><i class="fas fa-clock"></i></div>
                </div>
                <div class="card-single">
                    <div><h1 id="review-count">0</h1><span>Under Review</span></div>
                    <div><i class="fas fa-spinner"></i></div>
                </div>
                <div class="card-single">
                    <div><h1 id="resolved-count">0</h1><span>Resolved</span></div>
                    <div><i class="fas fa-check-double"></i></div>
                </div>
                <div class="card-single">
                    <div><h1 id="user-count">0</h1><span>Students</span></div>
                    <div><i class="fas fa-user-graduate"></i></div>
                </div>
            </div>      
            <div class="card">
                <div class="card-header">
                    <h3 id="table-title">Recent Problems Reported</h3>
                    <div id="filter-container">
                        <select id="category-filter" class="filter-input" onchange="applyFilters()">
                            <option value="All">All Categories</option>
                            <option value="Senior Faculty">Senior Faculty</option>
                            <option value="Junior Faculty">Junior Faculty</option>
                            <option value="Technical Staff">Technical Staff</option>
                            <option value="Lab Hardware">Lab Hardware</option>
                            <option value="Exam Section">Exam Section</option>
                            <option value="Technical Issues">Technical Issues</option>
                            <option value="Hygiene">Hygiene</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="age-legend" id="age-legend">
                    <span><span class="legend-dot yellow"></span> Unresolved 10–15 days</span>
                    <span><span class="legend-dot red"></span> Unresolved 15+ days</span>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

<script>
    let allIssues = [];
    let currentView = 'dashboard';

    // 1. Theme Logic
    const themeBtn = document.getElementById('theme-btn');
    if(localStorage.getItem('adminTheme') === 'dark') document.body.classList.add('dark-mode');
    themeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('adminTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    // 2. Fetch Complaints
    async function loadComplaints() {
        try {
            const res = await fetch('http://localhost:3001/api/complaints');
            allIssues = await res.json();
            updateStats(allIssues);
            applyFilters();
        } catch (e) {
            document.getElementById('table-body').innerHTML = "<tr><td colspan='5' style='text-align:center; color:red;'>API Connection Error</td></tr>";
        }
    }

    // 3. Filter Logic
function applyFilters() {
    if (currentView === 'students') return;

    const selectedCategory = document.getElementById('category-filter').value;
    
    const filtered = allIssues.filter(issue => {
        // Prepare the text for searching
        const issueCat = (issue.category || "").toLowerCase();
        const filterVal = selectedCategory.toLowerCase();
        
        // 1. Category Matching
        // If "All", return true. Otherwise, check if the filter text exists inside the category string.
        const matchesCat = (selectedCategory === 'All') || issueCat.includes(filterVal);
        
        // 2. Status Matching based on Sidebar View
        let matchesStatus = false;
        if (currentView === 'resolved') {
            matchesStatus = (issue.status === 'Resolved');
        } else if (currentView === 'underreview') {
            matchesStatus = (issue.status === 'Forwarded');
        } else if (currentView === 'dashboard') {
            matchesStatus = (issue.status === 'Pending' || issue.status === 'Forwarded');
        }
        
        return matchesCat && matchesStatus;
    });

    renderComplaintsTable(filtered);
}
    function getAgeDays(issue) {
        const timestamp = issue.createdAt || new Date(issue.date).getTime();
        if (!timestamp) return 0;
        return (Date.now() - timestamp) / (1000 * 60 * 60 * 24);
    }

    function getAgingInfo(issue) {
        if (issue.status === 'Resolved') {
            return { rowClass: '', tagHtml: '' };
        }
        const days = getAgeDays(issue);

        if (days > 15) {
            return {
                rowClass: 'age-danger',
                tagHtml: '<span class="age-tag danger"><i class="fas fa-fire"></i> ' + Math.floor(days) + 'd old</span>'
            };
        }
        if (days >= 10) {
            return {
                rowClass: 'age-warning',
                tagHtml: '<span class="age-tag warning"><i class="fas fa-exclamation-triangle"></i> ' + Math.floor(days) + 'd old</span>'
            };
        }
        return { rowClass: '', tagHtml: '' };
    }

    // 4. Render Table — aging applied here
    function renderComplaintsTable(data) {
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');

        tableHead.innerHTML = `<tr><td>ID</td><td>Category</td><td>Nature/Room</td><td>Status</td><td>Action</td></tr>`;

        tableBody.innerHTML = data.map(i => {
            const { rowClass, tagHtml } = getAgingInfo(i);
            return `
            <tr class="${rowClass}">
                <td><b style="color:var(--main-color)">#${i.complaintId}</b>${tagHtml}</td>
                <td>${i.category}</td>
                <td>${i.location}</td>
                <td><span class="status-badge status-${i.status.toLowerCase()}">${i.status}</span></td>
                <td>
                    <a href="Detail Complain.html?id=${i._id}" class="action-btn">
                        ${i.status === 'Forwarded' ? 'View & Resolve' : 'Review & Forward'}
                    </a>
                </td>
            </tr>`;
        }).join('');
    }

    // 5. Student View Logic
    async function loadStudentData() {
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        tableHead.innerHTML = `<tr><td>Name</td><td>Reg No</td><td>Email</td><td>Department</td><td>Security Hash</td></tr>`;
        
        try {
            const res = await fetch('http://localhost:3001/api/users');
            const students = await res.json();
            tableBody.innerHTML = students.map(s => `
                <tr>
                    <td><b>${s.fullname}</b></td>
                    <td>${s.regNo}</td>
                    <td>${s.email}</td>
                    <td>${s.department || 'N/A'}</td>
                    <td><span class="pass-code">${s.password.substring(0, 12)}...</span></td>
                </tr>
            `).join('');
        } catch (e) { tableBody.innerHTML = "<tr><td colspan='5'>Error</td></tr>"; }
    }

    // 6. Sidebar Switcher
    function switchView(view, el) {
        currentView = view;
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
        el.classList.add('active');
        
        const filter  = document.getElementById('filter-container');
        const cards   = document.getElementById('stats-cards');
        const title   = document.getElementById('table-title');
        const legend  = document.getElementById('age-legend');

        if (view === 'students') {
            filter.style.display = 'none';
            cards.style.display  = 'none';
            legend.style.display = 'none';   // hide legend on students tab
            title.innerText = "Registered Student Directory";
            loadStudentData();
        } else {
            filter.style.display = 'block';
            cards.style.display  = 'grid';
            // Only show legend when viewing unresolved complaints
            legend.style.display = (view === 'resolved') ? 'none' : 'flex';

            if (view === 'resolved')    title.innerText = "Resolved & Closed Cases";
            else if (view === 'underreview') title.innerText = "Under Review (Forwarded to Faculty)";
            else title.innerText = "Active Problems Feed";
            applyFilters();
        }
    }

    // 7. Stats
    function updateStats(issues) {
        document.getElementById('total-count').innerText    = issues.length;
        document.getElementById('pending-count').innerText  = issues.filter(i => i.status === 'Pending').length;
        document.getElementById('review-count').innerText   = issues.filter(i => i.status === 'Forwarded').length;
        document.getElementById('resolved-count').innerText = issues.filter(i => i.status === 'Resolved').length;
    }

    async function fetchUserCount() {
        const res   = await fetch('http://localhost:3001/api/users');
        const users = await res.json();
        document.getElementById('user-count').innerText = users.length;
    }

    // 8. Menu Toggle
    document.getElementById('menu-btn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('hide');
        document.getElementById('main-content').classList.toggle('expand');
        document.getElementById('header').classList.toggle('expand');
    });

    window.onload = () => { 
        loadComplaints(); 
        fetchUserCount(); 
    };
</script>
</body>
</html>